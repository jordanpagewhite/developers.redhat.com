---
apiVersion: v1
kind: Template
metadata:
  name: drupal-deployment
  annotations:
    openshift.io/display-name: "A DeploymentConfig that deploys a specific version of Drupal into an Openshift cluster."
    description: "A DeploymentConfig that deploys a specific version of Drupal."
    iconClass: icon-drupal
labels:
  drupal-deployment-id: "${DEPLOYMENT_ID}"
parameters:
- name: DEPLOYMENT_ID
  description: "The id of Drupal deployment that we are creating."
  required: true
- name: IMAGE_STREAM:
  description: "The Image Stream to pull the Drupal Docker Image from"
  required: true
objects:
- apiVersion: v1
  kind: DeploymentConfig
  metadata:
    name: drupal-deployment-${DEPLOYMENT_ID}
  spec:
    replicas: 1
    selector:
      drupal-deployment-id: "${DEPLOYMENT_ID}"
    revisionHistoryLimit: 3
    minReadySeconds: 0
    template:
      metadata:
        labels:
          drupal-deployment-id: "${DEPLOYMENT_ID}"
      spec:
        containers:
        - name: "drupal-${DEPLOYMENT_ID}"
          image: ${IMAGE_STREAM}:${DEPLOYMENT_ID}
          command: ['/uid_entrypoint.sh']
          args: ['/var/www/drupal/run-httpd.sh']
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          readinessProbe:
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 20
            httpGet:
              path: /
              port: 8080
          livenessProbe:
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 20
            httpGet:
              path: /
              port: 8080
          volumeMounts:
          - name: drupal-workspace
            mountPath: /var/www/drupal/web/images
            subPath: drupal_${DEPLOYMENT_ID}/developers.redhat.com/images
          - name: drupal-workspace
            mountPath: /var/www/drupal/web/sites/default/rhd.settings.yml
            subPath: drupal_${DEPLOYMENT_ID}/drupal/credentials/rhd.settings.yml
          - name: drupal-workspace
            mountPath: /var/www/drupal/web/sites/default/rhd.settings.php
            subPath: drupal_${DEPLOYMENT_ID}/drupal/credentials/rhd.settings.php
          - name: drupal-workspace
            mountPath: /var/www/drupal/web/sites/default/files
            subPath: drupal_${DEPLOYMENT_ID}/drupal/files
          - name: drupal-workspace
            mountPath: /var/www/drupal/web/config/active
            subPath: drupal_${DEPLOYMENT_ID}/drupal/config/active
          - name: drupal-workspace
            mountPath: /var/www/drupal/web/themes/custom/rhdp/rhd-frontend/rhd.min.js
            subPath: drupal_${DEPLOYMENT_ID}/drupal/theme/rhd.min.js
          - name: drupal-workspace
            mountPath: /var/www/drupal/web/themes/custom/rhdp/rhd-frontend/rhd.min.css
            subPath: drupal_${DEPLOYMENT_ID}/drupal/theme/rhd.min.css
          restartPolicy: Always
          # TODO - Make sure this is not 0 when we go live. This is just for testing!
          terminationGracePeriodSeconds: 0
          ports:
          - containerPort: 8080
            protocol: "TCP"
        volumes:
        - name: drupal-workspace
          persistentVolumeClaim:
            claimName: drupal-workspace