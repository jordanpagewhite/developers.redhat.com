#
# This playbook runs within the context of a fully bootstrapped Drupal container and performs any
# Drupal specific deployment steps. In the context of RHDP, this is mostly running drush commands
# and Phinx database migrations.
#
---
- hosts: localhost
  connection: local
  become: no
  vars:
    - work_dir: "/drupal-workspace/{{ drupal_deployment_dir }}/work"
  vars_files:
    - "/credentials/ansible/env.yml"
    - "vars/{{ rhdp_environment }}/drupal/vars.yml"
  tasks:
    - name: Rebuild the Drupal Cache
      shell: 'drush cr && touch {{ work_dir }}/drupal.cr.do.not.delete'
      register: drush_cr
      args:
        chdir: '/var/www/drupal/web'
        creates: "{{ work_dir }}/drupal.cr.do.not.delete"
    - debug:
       var: drush_cr.stdout_lines

    - name: Run Drupal Module Database Updates
      shell: 'drush -y --entity-updates updb && drush cr && touch {{ work_dir }}/drupal.updb.do.not.delete'
      register: entity_updates
      args:
        chdir: '/var/www/drupal/web'
        creates: "{{ work_dir }}/drupal.updb.do.not.delete"
    - debug:
       var: entity_updates.stdout_lines

    - name: Apply Lightning Profile Updates
      shell: 'drush update:lightning --no-interaction && drush cr && touch {{ work_dir }}/drupal.lightning.do.not.delete'
      register: lightning_updates
      args:
        chdir: '/var/www/drupal/web'
        creates: "{{ work_dir }}/drupal.lightning.do.not.delete"
    - debug:
       var: lightning_updates.stdout_lines

    - name: Import the latest Drupal configuration
      shell: 'drush -y cim && drush cr && touch {{ work_dir }}/drupal.cim.do.not.delete'
      register: drush_cim
      args:
        chdir: '/var/www/drupal/web'
        creates: "{{ work_dir }}/drupal.cim.do.not.delete"
    - debug:
       var: drush_cim.stdout_lines

    - name: Run Phinx Database Migrations
      shell: 'phinx migrate -e automated && touch {{ work_dir }}/drupal.phinx.do.not.delete'
      register: phinx_migrate
      args:
        chdir: '/var/www/drupal'
        creates: "{{ work_dir }}/drupal.phinx.do.not.delete"
      environment:
        PHINX_DB_HOST: "{{ drupal_db_host }}"
        PHINX_DB_NAME: "{{ drupal_deployment_dir }}"
        PHINX_DB_USER: "{{ drupal_db_user }}"
        PHINX_DB_PASSWORD: "{{ drupal_db_password }}"
    - debug:
       var: phinx_migrate.stdout_lines